<h2 class="ta-center">Table {{tableName}}</h2>
<table id="tour">
    <tr>
        {{#each tableInfo}}
        {{#if this.notHiddenField}}
        <th>{{this.column}}</th>
        {{/if}}
        {{/each}}
        <th>Action</th>
    </tr>
    {{#each tableData}}
    <tr>
        {{#each this}}
        <td>{{this}}</td>
        {{/each}}
        <td>
            <button class="btn btn-outline-secondary" data-toggle="modal" data-target="#Modal{{@index}}">
                Edit
            </button>
            <button class="btn btn-outline-danger" onclick="deleteRow('{{json this}}','{{../tableName}}')">
                Delete
            </button>
        </td>
    </tr>

    <!-- Modal -->
    <div class="modal fade" id="Modal{{@index}}" tabindex="-1" role="dialog" aria-hidden="true"
        aria-labelledby="exampleModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Edit</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        {{#each this}}
                        <div class="d-flex">
                            <span class="w-35">
                                {{@key}}
                            </span>
                            <input class="form-control" type="text" value="{{this}}" name="{{@key}}">
                        </div>
                        {{/each}}
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary"
                        onClick="saveChange(this,'{{json this}}','{{../tableName}}')">Save
                        changes</button>
                </div>
            </div>
        </div>
    </div>
    {{/each}}
</table>
<button class="btn btn-primary mt-2" data-toggle="modal" data-target="#AddNew">Add New Row</button>
<div class="modal fade" id="AddNew" tabindex="-1" role="dialog" aria-hidden="true" aria-labelledby="exampleModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Add New</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    {{#each tableInfo}}
                    {{#if this.notHiddenField}}
                    <div class="d-flex">
                        <span class="w-35">
                            {{this.column}}
                        </span>
                        <input class="form-control" type="text" value="" name="{{this.column}}">
                    </div>
                    {{/if}}
                    {{/each}}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onClick="addNew(this,'{{tableName}}')">Save
                    changes</button>
            </div>
        </div>
    </div>
</div>
<script>
    function addNew(e, tableName) {
        let listInput = e.parentNode.parentNode.querySelectorAll('input');
        let newObject = {};
        listInput.forEach((e) => {
            newObject[e.getAttribute('name')] = e.value;
        });

        $.ajax({
            url: "/table-detail/add",
            method: "post",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({
                data: newObject,
                tableName: tableName
            }),
            success: function (result) {
                if (result.status === "Success") {
                    alert('Thêm mới thành công');
                    // Refresh page
                    location.reload();
                }
                else{
                    alert("Thêm mới thất bại");
                }
            }
        })
        console.log(newObject);
    }

    function saveChange(e, oldObject, tableName) {
        oldObject = JSON.parse(oldObject);
        let listInput = e.parentNode.parentNode.querySelectorAll('input');
        let newObject = {};
        listInput.forEach((e) => {
            newObject[e.getAttribute('name')] = e.value;
        });
        $.ajax({
            url: "/table-detail/update",
            method: "post",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({
                data: {
                    oldObject: oldObject,
                    newObject: newObject
                },
                tableName: tableName
            }),
            success: function (result) {
                alert('Cập nhật thành công');
                // Refresh page
                location.reload();
            }
        })

    }

    function deleteRow(str, tableName) {
        let confirmDelete = confirm("Are you sure ?");
        let dataSend = JSON.parse(str);
        if (confirmDelete) {
            let dataDelete = JSON.parse(str);
            $.ajax({
                url: "/table-detail/delete",
                method: "post",
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify({
                    data: dataSend,
                    tableName: tableName
                }),
                success: function (result) {
                    alert('Xóa thành công')
                    // Refresh page
                    location.reload();
                }
            })
        }
    }
</script>